{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ titre_page }} - myschool{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'paiements:tableau_bord' %}">Paiements</a></li>
    <li class="breadcrumb-item"><a href="{% url 'eleves:detail_eleve' eleve.id %}">{{ eleve.prenom }} {{ eleve.nom }}</a></li>
    <li class="breadcrumb-item active">{{ action }} Échéancier</li>
{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-section h5 {
        color: #007bff;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    .eleve-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <form method="post" id="echeancierForm">
            {% csrf_token %}

            <!-- Informations de l'élève -->
            <div class="eleve-info">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1"><i class="fas fa-user me-2"></i>{{ eleve.prenom }} {{ eleve.nom }}</h6>
                        <small class="text-muted">Matricule : {{ eleve.matricule }} • {{ eleve.classe.nom }} - {{ eleve.classe.ecole.nom }}</small>
                    </div>
                    <div>
                        <a class="btn btn-outline-info btn-sm" href="{% url 'paiements:echeancier_eleve' eleve.id %}">
                            <i class="fas fa-calendar-alt me-1"></i>Voir échéancier
                        </a>
                    </div>
                </div>
            </div>

            <!-- Alerte d'information -->
            {% if grille %}
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Les montants et les dates d'échéance sont <strong>préchargés automatiquement</strong> à partir de la grille tarifaire de l'école
                    ({{ eleve.classe.ecole.nom }}) et des <strong>périodes définies</strong>. Vous n'avez rien à modifier.
                </div>
            {% else %}
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <div>
                        Aucune grille tarifaire trouvée pour cette classe ({{ eleve.classe.get_niveau_display }}) et l'année {{ form.annee_scolaire.value|default:eleve.classe.annee_scolaire }}.
                        <a class="alert-link ms-1" href="{% url 'admin:eleves_grilletarifaire_add' %}">Ajouter une grille tarifaire</a>
                        pour l'école <strong>{{ eleve.classe.ecole.nom }}</strong> et l'année <strong>{{ eleve.classe.annee_scolaire }}</strong>.
                    </div>
                </div>
            {% endif %}

            <!-- Montants dus -->
            <div class="form-section">
                <h5><i class="fas fa-money-bill me-2"></i>Montants dus</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.annee_scolaire.id_for_label }}" class="form-label">Année scolaire</label>
                        {{ form.annee_scolaire }}
                        {% if form.annee_scolaire.errors %}
                            <div class="text-danger small">{{ form.annee_scolaire.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.frais_inscription_du.id_for_label }}" class="form-label">Frais d'inscription (GNF)</label>
                        {{ form.frais_inscription_du }}
                        {% if form.frais_inscription_du.errors %}
                            <div class="text-danger small">{{ form.frais_inscription_du.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.tranche_1_due.id_for_label }}" class="form-label">1ère tranche (GNF)</label>
                        {{ form.tranche_1_due }}
                        {% if form.tranche_1_due.errors %}
                            <div class="text-danger small">{{ form.tranche_1_due.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.tranche_2_due.id_for_label }}" class="form-label">2ème tranche (GNF)</label>
                        {{ form.tranche_2_due }}
                        {% if form.tranche_2_due.errors %}
                            <div class="text-danger small">{{ form.tranche_2_due.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.tranche_3_due.id_for_label }}" class="form-label">3ème tranche (GNF)</label>
                        {{ form.tranche_3_due }}
                        {% if form.tranche_3_due.errors %}
                            <div class="text-danger small">{{ form.tranche_3_due.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Dates d'échéance -->
            <div class="form-section">
                <h5><i class="fas fa-calendar-check me-2"></i>Dates d'échéance</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.date_echeance_inscription.id_for_label }}" class="form-label">Date échéance inscription</label>
                        {{ form.date_echeance_inscription }}
                        {% if form.date_echeance_inscription.errors %}
                            <div class="text-danger small">{{ form.date_echeance_inscription.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.date_echeance_tranche_1.id_for_label }}" class="form-label">Date échéance Tranche 1</label>
                        {{ form.date_echeance_tranche_1 }}
                        {% if form.date_echeance_tranche_1.errors %}
                            <div class="text-danger small">{{ form.date_echeance_tranche_1.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.date_echeance_tranche_2.id_for_label }}" class="form-label">Date échéance Tranche 2</label>
                        {{ form.date_echeance_tranche_2 }}
                        {% if form.date_echeance_tranche_2.errors %}
                            <div class="text-danger small">{{ form.date_echeance_tranche_2.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.date_echeance_tranche_3.id_for_label }}" class="form-label">Date échéance Tranche 3</label>
                        {{ form.date_echeance_tranche_3 }}
                        {% if form.date_echeance_tranche_3.errors %}
                            <div class="text-danger small">{{ form.date_echeance_tranche_3.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'paiements:echeancier_eleve' eleve.id %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Annuler
                </a>
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="fas fa-save me-2"></i>{{ action }} l'échéancier
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Protection double-clic
document.addEventListener('DOMContentLoaded', function(){
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('echeancierForm');
    form.addEventListener('submit', function(){
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enregistrement...';
        setTimeout(function(){
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>{{ action }} l\'échéancier';
        }, 5000);
    });

    // Fallback d'affichage: si inputs date sont vides mais ont data-iso, les renseigner
    document.querySelectorAll('input[type="date"][data-iso]').forEach(function(el){
        if (!el.value && el.getAttribute('data-iso')) {
            el.value = el.getAttribute('data-iso');
        }
    });
});
</script>
{% endblock %}
